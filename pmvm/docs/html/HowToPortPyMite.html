<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.6: http://docutils.sourceforge.net/" />
<title>How To Port PyMite</title>
<meta name="author" content="Dean Hall" />
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 5951 2009-05-18 18:03:10Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left{
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: left }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="how-to-port-pymite">
<h1 class="title">How To Port PyMite</h1>
<table class="docinfo" frame="void" rules="none">
<col class="docinfo-name" />
<col class="docinfo-content" />
<tbody valign="top">
<tr><th class="docinfo-name">Author:</th>
<td>Dean Hall</td></tr>
<tr class="field"><th class="docinfo-name">Id:</th><td class="field-body">HowToPortPyMite.txt 599 2010-09-14 18:34:20Z dwhall256</td>
</tr>
</tbody>
</table>
<!-- Copyright 2009 Dean Hall
Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.2
or any later version published by the Free Software Foundation;
with no Invariant Sections, no Front-Cover Texts, and no Back-Cover
Texts.  A copy of the license is in the file docs/LICENSE. -->
<div class="section" id="purpose">
<h1>Purpose</h1>
<p>This document describes in a step-by-step manner how to port the PyMite
interpreter to a new platform.  In doing so, it serves as a guide
for the PyMite developer.</p>
</div>
<div class="section" id="requirements">
<h1>Requirements</h1>
<p>The following is needed in order to port and compile PyMite to a new platform:</p>
<ul class="simple">
<li>A C language toolchain (such as GCC) that includes the C compiler, assembler
and linker for the target platform.</li>
<li>A build system, preferably Make (preferably GNU Make) or Scons (www.scons.org).</li>
</ul>
<p>Starting from a sample project that configures the the communications
peripheral serving as stdio (UART) and has a working build system (Makefile)
is <strong>highly recommended</strong>.</p>
</div>
<div class="section" id="porting">
<h1>Porting</h1>
<p>Here is a step-by-step guide to porting PyMite to a new platform.</p>
<ul>
<li><p class="first">Copy an existing platform directory that most closely resembles the new target
platform.  For the rest of this document, the new directory is referred to as
<tt class="docutils literal">&lt;plat&gt;</tt>.  The core files needed for the port are <tt class="docutils literal">main.c</tt>, <tt class="docutils literal">plat.c</tt>,
<tt class="docutils literal">plat.h</tt>, <tt class="docutils literal">pmfeatures.py</tt> and <tt class="docutils literal">Makefile</tt>.  Other files that might be
useful are `` main.py`` and <tt class="docutils literal">SConscript</tt>.  Remove all the extraneous files.</p>
</li>
<li><p class="first">Edit <tt class="docutils literal">pmfeatures.py</tt> to set the features that you want the VM to have.
Find the meaning of all the <tt class="docutils literal">HAVE_*</tt> variables in
<tt class="docutils literal">src/vm/pmFeatureDependencies.h</tt>.</p>
</li>
<li><p class="first">Edit <tt class="docutils literal">plat.h</tt> to set the size of the platform's heap in <tt class="docutils literal">PM_HEAP_SIZE</tt>
and be sure to leave enough RAM for the C stack.</p>
</li>
<li><p class="first">Edit the build environment so that it builds the PyMite library,
<tt class="docutils literal"><span class="pre">../../vm/libpmvm_&lt;plat&gt;.a</span></tt>, and links it to <tt class="docutils literal">main.c</tt>, <tt class="docutils literal">plat.c</tt>
and the native and image files that are generated by pmImgCreator.py
from your Python source code.  Below are example lines for a Makefile
that would be needed in addition to make a complete Makefile:</p>
<pre class="literal-block">
# PyMite: Configuration
PLATFORM := $(notdir $(CURDIR))
PM_LIB_ROOT = pmvm_$(PLATFORM)
PM_LIB_FN = lib$(PM_LIB_ROOT).a
PM_LIB_PATH = ../../vm/$(PM_LIB_FN)
PM_USR_SOURCES = main.py
PMIMGCREATOR := ../../tools/pmImgCreator.py
PMGENPMFEATURES := ../../tools/pmGenPmFeatures.py
TARGET = main
SRC = $(TARGET).c plat.c $(TARGET)_nat.c $(TARGET)_img.c
# If you want to be able to run ipm, uncomment the following line
#IPM = true

# PyMite: CFLAGS
ifeq ($(DEBUG),true)
    CDEFS += -g -gstabs -D__DEBUG__=1
endif
CINCS += -I$(abspath .)
CFLAGS += $(CDEFS) $(CINCS)

# Define the toolchain
CC = arm-elf-gcc
CPP = arm-elf-g++
OBJCOPY = arm-elf-objcopy
OBJDUMP = arm-elf-objdump
SIZE = arm-elf-size
AR = arm-elf-ar
NM = arm-elf-nm

# PyMite: Build the VM archive if it doesn't exist
pmvm : $(PM_LIB_PATH)

$(PM_LIB_PATH) :
    make -C ../../vm

pmfeatures.h : pmfeatures.py $(PMGENPMFEATURES)
    $(PMGENPMFEATURES) pmfeatures.py &gt; $&#64;

# PyMite: Generate native code and module images from the python source
$(TARGET)_nat.c $(TARGET)_img.c : $(PM_USR_SOURCES)
  $(PMIMGCREATOR) -f pmfeatures.py -c -u -o $(TARGET)_img.c --native-file=$(TARGET)_nat.c $(PM_USR_SOURCES)

# PyMite: tell the compiler where to find pm.h and libpmvm_&lt;plat&gt;.a
CFLAGS += -I../../
LDFLAGS += -L../../vm -lpmvm_&lt;plat&gt;

# PyMite: Append pmvm to the list of .PHONY targets
.PHONY : pmvm

# PyMite: Export these env variables so the Makefile in ../../vm gets them
export CC OBJCOPY NM CFLAGS ALL_CFLAGS AR IPM PM_LIB_FN

# PyMite: Append these intermediate files to the list of things to clean
clean :
    $(REMOVE) $(TARGET)_img.c
    $(REMOVE) $(TARGET)_nat.c
    $(REMOVE) pmfeatures.py
</pre>
</li>
<li><p class="first">Edit <tt class="docutils literal">plat.c</tt> to replace <tt class="docutils literal">#include</tt> statements with ones for the new
platform.  Edit the <tt class="docutils literal">plat_init()</tt> function to enable the peripheral to be
used for PyMite's stdio (usually UART0).  If PyMite sys.time() or threading
is desired, also edit <tt class="docutils literal">plat_init()</tt> to initialize a timer or other periodic
callback and the corresponding timer interrupt service routine (ISR) or
callback function.  The ISR or callback function simply needs to call
<tt class="docutils literal"><span class="pre">pm_vmPeriodic(&lt;us&gt;);</span></tt> with an argument that is the number of microseconds
that have passed since it was last called.</p>
</li>
<li><p class="first">Edit the <tt class="docutils literal">plat_memGetByte()</tt> function in <tt class="docutils literal">plat.c</tt> to match the platform's
memory architecture.  A microcontroller that uses the von Neumann
architecture, such as ARM7TDMI, the RAM and program memory will use the same
kind of memory access. Here is an implementation for von Neumann
architectures:</p>
<pre class="literal-block">
uint8_t plat_memGetByte(PmMemSpace_t memspace, uint8_t const **paddr)
{
    uint8_t b = 0;

    switch (memspace)
    {
        case MEMSPACE_RAM:
        case MEMSPACE_PROG:
            b = **paddr;
            *paddr += 1;
            return b;
        /* Removed unused cases for brevity */
    }
}
</pre>
<p>However, a microcontroller that uses the Harvard architecture, such as AVR,
might need an API call to read from the program memory.  Here is an
implementation for Harvard architecture with AVR-specific API:</p>
<pre class="literal-block">
uint8_t plat_memGetByte(PmMemSpace_t memspace, uint8_t const **paddr)
{
    uint8_t b = 0;

    switch (memspace)
    {
        case MEMSPACE_RAM:
            b = **paddr;
            *paddr += 1;
            return b;

        case MEMSPACE_PROG:
            b = pgm_read_byte(*paddr);
            *paddr += 1;
            return b;
        /* Unused cases removed for brevity */
    }
}
</pre>
</li>
<li><p class="first">Edit the <tt class="docutils literal">plat_getByte()</tt> function in <tt class="docutils literal">plat.c</tt> to read a byte from the
platform's designated stdio peripheral and return the byte by reference.
Follow the existing code to raise an exception if an I/O error occurs.</p>
</li>
<li><p class="first">Edit the <tt class="docutils literal">plat_putByte()</tt> function in <tt class="docutils literal">plat.c</tt> to write a byte to the
platform's designated stdio peripheral.
Follow the existing code to raise an exception if an I/O error occurs.</p>
</li>
<li><p class="first">Edit the <tt class="docutils literal">plat_getMsTicks()</tt> function in <tt class="docutils literal">plat.c</tt> to return, by reference,
the current number of milliseconds since system power-up (or reset if that is
preferred).  This function may either return <tt class="docutils literal">pm_timerMsTicks</tt> which
requires that <tt class="docutils literal">pm_vmPeriodic()</tt> be called faithfully, or it may fetch a
value from the platform's time-keeping system (such as a real time clock
peripheral).  The datatype holding the number of milliseconds is four bytes
(32 bits).  This means that it might be required to disable interrupts
while copying the value in order to avoid corruption; furthermore, PyMite
will experience system time &quot;rollover&quot; every 49 days (roughly).</p>
</li>
<li><p class="first">Edit the <tt class="docutils literal">plat_reportError()</tt> function in <tt class="docutils literal">plat.c</tt> to report unhandled
exceptions and other incorrect return states.  A common method is to print
on stdout.  The <tt class="docutils literal">desktop</tt> and <tt class="docutils literal">avr</tt> platform implementations demonstrate
how to print the error status and a Python-like traceback on stdout.</p>
</li>
</ul>
<!-- :mode=rest: -->
</div>
</div>
</body>
</html>
