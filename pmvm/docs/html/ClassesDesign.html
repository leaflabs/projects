<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.6: http://docutils.sourceforge.net/" />
<title>PyMite Class Design</title>
<meta name="author" content="Dean Hall" />
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 5951 2009-05-18 18:03:10Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left{
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: left }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="pymite-class-design">
<h1 class="title">PyMite Class Design</h1>
<table class="docinfo" frame="void" rules="none">
<col class="docinfo-name" />
<col class="docinfo-content" />
<tbody valign="top">
<tr><th class="docinfo-name">Author:</th>
<td>Dean Hall</td></tr>
<tr class="field"><th class="docinfo-name">Id:</th><td class="field-body">ClassesDesign.txt 357 2009-05-02 18:05:16Z dwhall256</td>
</tr>
</tbody>
</table>
<!-- Copyright 2009 Dean Hall
Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.2
or any later version published by the Free Software Foundation;
with no Invariant Sections, no Front-Cover Texts, and no Back-Cover
Texts.  A copy of the license is in the file docs/LICENSE. -->
<div class="section" id="purpose">
<h1>Purpose</h1>
<p>This document describes the PyMite virtual machine (VM) support for classes.
In doing so, it serves as a design document for the PyMite developer.</p>
</div>
<div class="section" id="overview">
<h1>Overview</h1>
<p>The PyMite VM has the simplest possible implementation of classes that allows
it to operate without changing the output from the Python compiler.
What this means is that the PyMite programmer will write code to create classes
just as he would for Python.  The code will be run through pmImgCreator.py
just like all other PyMite code.</p>
</div>
<div class="section" id="python-classes-walk-through">
<h1>Python Classes Walk-through</h1>
<p>This section discusses the design of PyMite classes by reverse-engineering
Python classes, leaving out irrelevant details and honing the simplest solution.
The study of classes begins by disassembling the following code:</p>
<pre class="literal-block">
class Foo(object):
    a=42
    def bar(self,):
        pass

foo = Foo()
foo.bar()
</pre>
<p>Use <tt class="docutils literal">src/tools/dismantle.py</tt> to disassemble the code above.  The rest of
this discussion will study snippets of the output from dismantle.
The first thing to observe is that compiling the code above results in
three code objects: the module, the class <tt class="docutils literal">Foo</tt> and the function <tt class="docutils literal">bar</tt>
(<tt class="docutils literal">bar</tt> is not a method yet).</p>
<p>Examining the bytecode of the module's code object, we see that it builds
the class <tt class="docutils literal">Foo</tt>, creates the instance <tt class="docutils literal">foo</tt> and then calls the method
<tt class="docutils literal">bar</tt> and discards the result.  Here is the bytecode that builds the class:</p>
<pre class="literal-block">
 0 LOAD_CONST               0 ('Foo')
 3 LOAD_NAME                0 (object)
 6 BUILD_TUPLE              1
 9 LOAD_CONST               1 (&lt;code object Foo at 0x779b0, file &quot;t202.py&quot;, line 13&gt;)
12 MAKE_FUNCTION            0
15 CALL_FUNCTION            0
18 BUILD_CLASS
19 STORE_NAME               1 (Foo)
</pre>
<p>As of PyMite release 08, every bytecode in the listing above is supported
with the exception of <tt class="docutils literal">BUILD_CLASS</tt>.  By studying the bytecode above
and also looking inside the <a class="reference external" href="http://svn.python.org/view/python/trunk/Python/ceval.c?view=markup">CPython implementation</a> of the <tt class="docutils literal">BUILD_CLASS</tt>
bytecode, we see that <tt class="docutils literal">BUILD_CLASS</tt> takes three items from the stack:</p>
<ol class="arabic simple">
<li>locals dict from executing Foo() as a function.  Its contents are:
<tt class="docutils literal">{&quot;__module__&quot; : &quot;__name__&quot;, a : 42, bar : &lt;function&gt;}</tt></li>
<li>tuple: (object,)</li>
<li>string: &quot;Foo&quot;</li>
</ol>
<p>This will be a good place to implement the function
<tt class="docutils literal">class_new(attrs, bases, name, r_pobj)</tt> and make a call to it.</p>
<p>The next block of the disassembly seems redundant, but there's a subtle
difference:</p>
<pre class="literal-block">
22 LOAD_NAME                1 (Foo)
25 CALL_FUNCTION            0
28 STORE_NAME               2 (foo)
</pre>
<p>Didn't we just execute <tt class="docutils literal">Foo</tt> in the previous block?  Yes, but it was a <em>code</em>
object back then.  In this block, <tt class="docutils literal">Foo</tt> is the <em>class</em> object that was created
by <tt class="docutils literal">BUILD_CLASS</tt>.   This code is responsible for creating an instance of
class <tt class="docutils literal">Foo</tt>.  Which means the <tt class="docutils literal">CALL_FUNCTION</tt> bytecode implementation
is going to need a special case to:</p>
<ol class="arabic simple">
<li>detect when the called item is a class</li>
<li>create an instance of the class</li>
<li>create the method from <tt class="docutils literal">__init__()</tt> if it exists and run it</li>
</ol>
<p>That's a lot to do, so the helper function, <tt class="docutils literal">class_instatiate(class, r_pobj)</tt>
will be created.</p>
<p>The final block of code is where a little bit of magic happens:</p>
<pre class="literal-block">
31 LOAD_NAME                2 (foo)
34 LOAD_ATTR                3 (bar)
37 CALL_FUNCTION            0
40 POP_TOP
41 LOAD_CONST               2 (None)
44 RETURN_VALUE
</pre>
<p>At this point <tt class="docutils literal">foo</tt> is an instance, but it does not have any attributes,
methods, nada.  The bytecode <tt class="docutils literal">LOAD_ATTR</tt> needs a special case to look into
an instance's parental tree to find the attribute <tt class="docutils literal">bar</tt>.  If <tt class="docutils literal">bar</tt> is
a function, then a method needs to be created from the function.  The structure
used to represent a method contains three important things: the instance
which becomes the &quot;<em>self</em>&quot; parameter later on, the function and the class.</p>
<p>Next, the <tt class="docutils literal">CALL_FUNCTION</tt> bytecode implementation will need a special case
to detect a method and insert the instance object as the &quot;<em>self</em>&quot; parameter
on the stack before calling the instance's function.</p>
</div>
<div class="section" id="a-little-bit-of-efficiency">
<h1>A Little Bit of Efficiency</h1>
<p>In the section above, I mentioned two special cases that needed to be added
to the implementation of the bytecode <tt class="docutils literal">CALL_FUNCTION</tt>.  One to detect
a class and create an instance; another to detect a method and call its
function.  While implementing these two special cases, I discovered that
by ordering them appropriately, one case naturally followed the other.</p>
<p>The first case creates an instance of a class and, if the <tt class="docutils literal">__init__</tt>
function exists, must call it as a method.  The second case detects a method,
does the all-important insertion of the <tt class="docutils literal">self</tt> parameter and calls the
function.  So, by adding the proper logic, these two special cases naturally
coexist even when methods other than <tt class="docutils literal">__init__()</tt> are called.</p>
</div>
<div class="section" id="design-decisions">
<h1>Design Decisions</h1>
<p>In a Python class, the instance intializer function is named
<tt class="docutils literal"><span class="pre">__init__(self,...)</span></tt>.  In PyMite, it would be possible to allow a differently
named function to serve as the initializer, such as one with a shorter name
that would conserve memory.  However, the name should be kept <tt class="docutils literal">__init__</tt>
so that the same source code can run properly in CPython.</p>
<p>At this point, all the meta-classes and meta-methods are not going to be part
of the design.  This is to keep the design simple and small.</p>
<!-- :mode=rest: -->
</div>
</div>
</body>
</html>
