<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.6: http://docutils.sourceforge.net/" />
<title>PyMite Generator Design</title>
<meta name="author" content="Dean Hall" />
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 5951 2009-05-18 18:03:10Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left{
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: left }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="pymite-generator-design">
<h1 class="title">PyMite Generator Design</h1>
<h2 class="subtitle" id="supporting-the-keyword-yield">Supporting the keyword yield</h2>
<table class="docinfo" frame="void" rules="none">
<col class="docinfo-name" />
<col class="docinfo-content" />
<tbody valign="top">
<tr><th class="docinfo-name">Author:</th>
<td>Dean Hall</td></tr>
<tr class="field"><th class="docinfo-name">Id:</th><td class="field-body">GeneratorDesign.txt 364 2009-05-17 21:11:51Z dwhall256</td>
</tr>
</tbody>
</table>
<!-- Copyright 2009 Dean Hall
Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.2
or any later version published by the Free Software Foundation;
with no Invariant Sections, no Front-Cover Texts, and no Back-Cover
Texts.  A copy of the license is in the file docs/LICENSE. -->
<div class="section" id="purpose">
<h1>Purpose</h1>
<p>This document describes the PyMite virtual machine (VM) support for the
yield keyword's use to create generators.
In doing so, it serves as a design document for the PyMite developer.</p>
</div>
<div class="section" id="overview">
<h1>Overview</h1>
<p>The PyMite VM shall support the three forms of generators: iterator functions,
generator expressions and coroutines.
Background information on simple generators in Python is found in <a class="reference external" href="http://www.python.org/dev/peps/pep-0255/">PEP 255</a>
while coroutines via enhanced generators is found in <a class="reference external" href="http://www.python.org/dev/peps/pep-0342/">PEP 342</a>.
Generators in PyMite follow the designs in these PEPs, but may not implement
them in their entirety.  Furthermore, the implementation of generators in PyMite
is done by reverse engineering output from the Python compiler.
What this means is that the PyMite programmer will write code to create a
generator just as he would for Python.  The code will be run through
pmImgCreator.py, which uses Python's compiler, just like all other PyMite code.</p>
</div>
<div class="section" id="python-generator-iterators-walk-through">
<h1>Python Generator-iterators Walk-through</h1>
<p>This section discusses the design of PyMite generator-iterators by
reverse-engineering Python, leaving out irrelevant details and honing the
simplest solution. The study of iterators begins by disassembling the following
code, an infinite iterator that generates the Fibonacci sequence and a simple
for loop that requests values from the iterator:</p>
<pre class="literal-block">
def fib():
    a, b = 0, 1
    while True:
        yield a
        a, b = b, a+b

for i in fib():
    print i,
    if i &gt; 256:
        break
</pre>
<p>Use <tt class="docutils literal">src/tools/dismantle.py</tt> to disassemble the code above.  The rest of
this discussion will study snippets of the output from dismantle.
The first thing to observe is that compiling the code above results in
two code objects: the module and the function <tt class="docutils literal">fib</tt>.</p>
<p>Examining the bytecode of the module's code object, we see that it builds
the function <tt class="docutils literal">fib</tt> just as it would any other function.  <tt class="docutils literal">fib</tt> becomes
a generator-iterator function.  Below is the bytecode that shows how the
generator-iterator function is used:</p>
<pre class="literal-block">
24           9 SETUP_LOOP              39 (to 51)
            12 LOAD_NAME                0 (fib)
            15 CALL_FUNCTION            0
            18 GET_ITER
       &gt;&gt;   19 FOR_ITER                28 (to 50)
            22 STORE_NAME               1 (i)
</pre>
<p>As of PyMite release 08, every bytecode in the listing above is supported.
However, the <tt class="docutils literal">CALL_FUNCTION</tt> bytecode needs to be changed to detect when
the function is a generator and to create a generator instance as needed.
This is done by inspecting a flag that is set in the code object by
the compiler.  The generator is going to be an instance of a new Generator
class that is declared in PyMite's buildins, src/lib/__bi.py.
Next, the <tt class="docutils literal">GET_ITER</tt> bytecode needs  to be changed
to ignore the top-of-stack when it is a generator.  The <tt class="docutils literal">FOR_ITER</tt> bytecode
then needs to detect a generator object and call its next method.
The next method is responsible for executing the generator
function until it yields a result.  The yielded result is put on the stack
and used by the next bytecode, STORE_NAME.</p>
<p>Inside the function <tt class="docutils literal">fib</tt>, the only new thing is the yield statement that
results in the following bytecode:</p>
<pre class="literal-block">
21          22 LOAD_FAST                0 (a)
            25 YIELD_VALUE
            26 POP_TOP
</pre>
<p>The <tt class="docutils literal">YIELD_VALUE</tt> bytecode needs to be implemented.  It is resposible
for placing the item on this function's top-of-stack on the caller's
top-of-stack, where &quot;the caller&quot; is whomever called the generator's <tt class="docutils literal">next()</tt>
or <tt class="docutils literal">send()</tt> method.  This differs from <tt class="docutils literal">RETURN_VALUE</tt> in that the
generator's function is not disposed of; it is kept in the generator instance
so it can be called again, resuming execution one instruction after
<tt class="docutils literal">YIELD_VALUE</tt>.</p>
</div>
<div class="section" id="generator-expressions">
<h1>Generator Expressions</h1>
<p>A generator expression is an expression that looks like a list-comprehension
wrapped in parentheses rather than brackets.  The following is an example
generator expression:</p>
<pre class="literal-block">
b = (2*x for x in a)
</pre>
<p>The Python compiler creates the following bytecode for the generator
expression:</p>
<pre class="literal-block">
24          18 LOAD_CONST               4 (&lt;code object &lt;genexpr&gt; at 0x75a...&gt;)
            21 MAKE_FUNCTION            0
            24 LOAD_NAME                0 (a)
            27 GET_ITER
            28 CALL_FUNCTION            1
            31 STORE_NAME               1 (b)
</pre>
<p>This disassembly reveals the the Python compiler turned the generator expression
into an anonymous generator function.  So, the behavior of a generator
expression is identical to a generator function and no extra changes to the VM
are necessary to support generator expressions.</p>
</div>
<div class="section" id="generator-coroutines">
<h1>Generator Coroutines</h1>
<p>A generator coroutine is created by defining a function and using a yield
expression inside the function.  The yield expression can accept an argument
as well as return a value.  A demonstration coroutine and how to use
it is seen below (line numbers are added for discussion):</p>
<pre class="literal-block">
0 def coro(n):
1     outgoing = 0
2     while True:
3         incoming = (yield outgoing)
4         print &quot;I shall print the incoming message&quot;, n, &quot;times:&quot;, incoming * n
5         outgoing += 1
6
7 c3 = coro(3)
8 print &quot;Priming coro:&quot;, c3.next()
9 print &quot;Sending 'moo':&quot;, c3.send(&quot;moo&quot;)
</pre>
<p>Inside the function, the line with the yield expression, line 3, is the only
thing special in the source code.  However, because it is a coroutine (and not
a function) it is used in a special manner.  Line 7 shows that <tt class="docutils literal">coro()</tt> is
called with an argument and its output is stored in <tt class="docutils literal">c3</tt>.  But because it is
a coroutine, it returns a generator object, so <tt class="docutils literal">c3</tt> is an instance of class
<tt class="docutils literal">Generator</tt>.  It is important to note that the call to <tt class="docutils literal">coro()</tt> did not
execute any code inside the coroutine, it simply created an instance of
coroutine and an execution frame which will be used to run the code and
save execution state later on.  The first call to a coroutine must be the
<tt class="docutils literal">next()</tt> method.  The first call to <tt class="docutils literal">next()</tt> executes the code inside the
coroutine from the start to the first yield statement.  Now, the coroutine
is ready to accept input via the <tt class="docutils literal">send()</tt> method.</p>
<p>Despite the long-winded explanation, there is very little about
generator-coroutines that differs from generator-iterators.  The one difference
is that arguments can now be sent to the generator via the <tt class="docutils literal">send()</tt> method.
This is done by a simple stack push operation.</p>
<p>One issue not encountered in the example code above is what happens when a
coroutine returns.  According to PEP 342, a GeneratorExit exception should
be raised.  So a special case is added to <tt class="docutils literal">RETURN_VALUE</tt> to detect when
returning from a coroutine.  PyMite does not support exceptions at the time
of this writing, so instead of raising the exception, an attempt is made to
jump to a handler in the block stack.  If no handler is found, the VM exits
with an error.  This behavior is not ideal, but it works compactly for now.
A change to this behavior may be needed in the future.</p>
</div>
<div class="section" id="design-decisions">
<h1>Design Decisions</h1>
<p>PEP 342 states that a generator object has these methods: <tt class="docutils literal">__init__, next, send,
throw, close</tt> and <tt class="docutils literal">__del__</tt>.  This implementation supports the first three
methods, but not the latter three.  Methods <tt class="docutils literal">throw</tt> and <tt class="docutils literal">close</tt> make use
of the ability to catch exceptions which is not yet supported in PyMite.
And <tt class="docutils literal">__del__</tt> requires the ability to run code during a garbage collection
which is not support by the current infrastructure.  The author decided to
go ahead with this incomplete implementation since it supports the most common
uses of generators and will provide a great new feature with a small increase
in code size.  Completing the implementation may performed in the future.</p>
<!-- :mode=rest: -->
</div>
</div>
</body>
</html>
